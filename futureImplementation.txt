Looking at the implementation summary you provided, I can see it focuses on the authentication, user management, and clinic configuration modules. Let me analyze this against the comprehensive PDF documentation and create an updated
   functionality list.

  ğŸ“‹ UPDATED FUNCTIONALITIES TO IMPLEMENT

  Based on the technical summary and the complete documentation, here are the functionalities organized by implementation phase:

  ---
  ğŸ¯ PHASE 1 - MVP (Immediate Implementation)

  1ï¸âƒ£ AUTHENTICATION & ACCOUNT REGISTRATION

  Owner Account Creation

  - âœ… Register account with email/password
  - âœ… Email verification with 24h token
  - âœ… Optional MFA (OTP via email or WhatsApp)
  - âœ… Accept Terms & Conditions (simple electronic signature with IP stamp)
  - âœ… Create Tenant (clinic/IPRESS) linked to owner
  - âœ… Account states: Draft â†’ Incomplete â†’ Active â†’ Suspended â†’ Closed
  - âœ… Audit every state change (audit_logs with user, IP, timestamp)

  Doctor Authentication

  - âœ… 24-hour JWT for doctor login (email + password)
  - âœ… Argon2id password encryption
  - âœ… Session management with HTTP-only cookies

  Patient Authentication

  - âœ… OTP via WhatsApp (6-digit, 5-min TTL)
  - âœ… 24-hour JWT for payment flow
  - âœ… Create/retrieve patient in Patients_Table_V2

  Chatbot Authentication

  - âœ… 2-hour JWT for AI assistant sessions
  - âœ… Automatic JWT rotation (when expired or <5 min remaining)
  - âœ… Session storage in wa_sessions (15-min idle TTL, 1-hour max)

  ---
  2ï¸âƒ£ ACCOUNT SETTINGS MODULE

  Account Profile

  - âœ… Owner data management (with "Clear data" button + warning)
  - âœ… Organization Location:
    - Country (locked after initial setup)
    - State/Region (locked after initial setup)
    - City (editable for typos/district changes)
    - Timezone (auto-set by country, locked)
    - Language (auto-set by country, editable; Spanish default, multi-language enabled)
    - Date format (auto-internal, not user-changeable)
  - âœ… Close account (deactivates access, preserves clinical records per law)

  Account Security

  - âœ… Contact management, password changes
  - âœ… Audit history (Phase 2: filters + CSV export)

  ---
  3ï¸âƒ£ USERS & PERMISSIONS MODULE

  User Management

  - âœ… List all users created by owner
  - âœ… Display: Name, Email, Role, Status, Last Login
  - âœ… Operational States (5-state flow):
    - ğŸŸ  Invited â†’ Invitation sent, pending activation
    - ğŸŸ¡ Incomplete â†’ Account activated, profile incomplete
    - ğŸŸ£ Pending â†’ Profile complete, awaiting admin validation
    - ğŸŸ¢ Active â†’ Validated, can receive appointments
    - ğŸ”´ Inactive â†’ Administratively disabled

  Doctor Invitation Flow

  - âœ… Invite User Modal:
    - Full name (required)
    - Email (required, valid format)
    - Role (default: Clinical in Phase 1)
  - âœ… Generate single-use invite token (JWT/UUID, 24h validity)
  - âœ… Send invitation email with secure link
  - âœ… Confirmation Modal:
    - "A secure link will be sent to the entered email"
    - "Link expires in 24 hours"
    - "Do not share this link"
    - Complies with Law 29733 & OWASP best practices

  Invitation Email (Sent to Doctor)

  - âœ… Personalized greeting: "Hello, Dr. [Name]"
  - âœ… Explanation: Invited by [Clinic Name] to join Vitas
  - âœ… [Activate Account] button
  - âœ… 24-hour expiration notice
  - âœ… Security warning: "Do not share this email or link"
  - âœ… Legal footer (Law 29733 compliance)

  Activation Screen (Doctor completes)

  - âœ… Create password (min 8 chars, 1 uppercase, 1 lowercase, 1 number)
  - âœ… Confirm password (with validation)
  - âœ… Password strength indicator (Weak/Medium/Strong)
  - âœ… Accept Terms & Privacy Policy (checkbox + link)
  - âœ… [Activate Account] button
  - âœ… [Cancel Activation] button (with warning modal)
  - âœ… Auto-login after activation (no manual login required)
  - âœ… Redirect to Clinical Profile to complete professional data

  ---
  4ï¸âƒ£ CLINICAL PROFILE OF DOCTOR

  Professional Profile Completion

  - âœ… Personal Data:
    - Full name (read-only if from invitation)
    - Document type & number (DNI/CE/Passport)
    - Date of birth (age auto-calculated)
    - Gender, Address
    - Personal phone & emergency contact
    - Email (read-only if from invitation)
    - Digital signature (PNG image for clinical documents, Law 27269)
  - âœ… Professional Data:
    - Profession (Doctor, Nurse, Obstetrician, etc.)
    - CMP (required if Profession = Doctor)
    - RNE (if applicable)
    - Primary specialty (+ optional subspecialty)
    - Primary work location (required)
    - Secondary work location (optional)

  Profile States & Validation

  - âœ… Badge States:
    - ğŸŸ¡ Incomplete â†’ Missing CMP/Specialty/Location
    - ğŸŸ£ Pending â†’ Complete, awaiting admin validation
    - ğŸŸ¢ Active â†’ Validated and schedulable
  - âœ… Owner Validation:
    - "Verify Profile" button
    - Changes status from Pending â†’ Active
    - Creates/updates Practitioner & PractitionerRole
    - Registers AuditEvent with IP timestamp

  Onboarding vs Normal Mode

  - âœ… Onboarding Mode (from activation link):
    - Opens in edit mode by default
    - Toast: "Account activated. Complete your professional profile."
    - Hides sidebar, owner modules, AI assistant, notifications
  - âœ… Normal Mode (after Active):
    - Full platform layout (sidebar + modules)
    - Opens in read-only; "Edit" button available

  ---
  5ï¸âƒ£ LEGAL DOCUMENTS & CONSENTS

  Document Management

  - âœ… Owner creates/uploads institutional legal documents:
    - Custom title (e.g., "Privacy Policy", "Teleconsultation Consent")
    - Public URL or signed PDF hosted on clinic's website
    - Version & effective date
  - âœ… Download VITAS Base Template:
    - Disclaimer: "Template must be reviewed, adapted, and legally validated by the clinic before publication. VITAS assumes no responsibility for modified content."
  - âœ… Document Versioning:
    - Each document includes: policyUri, version, hash (integrity check)
    - If owner changes document/version â†’ previous consents marked as Outdated
    - AI assistant requests re-acceptance from patient

  Patient Consent Flow

  - âœ… Manual Mode (Phase 1):
    - Doctor downloads documents
    - Patient signs physically
    - Doctor uploads signed document
    - Status: âœ… Verified (manual)
  - âœ… Intelligent Mode (AI Assistant):
    - AI sends policyUri links to patient via WhatsApp
    - Patient accepts digitally (simple electronic signature)
    - Status: âœ… Accepted (intelligent)
  - âœ… Consent States:
    - âŒ Not Accepted â†’ No external messages allowed
    - âœ… Accepted â†’ Patient can receive notifications
    - âœ— Revoked â†’ All external messaging stops immediately
    - â— Outdated â†’ Document version changed, re-acceptance required

  Audit & Traceability

  - âœ… Every consent acceptance logged:
    - userId, terms_version, hash_terms, IP, timestamp, action
  - âœ… AuditEvent + Provenance (FHIR)
  - âœ… WORM storage (S3 Object Lock - Compliance mode)

  ---
  6ï¸âƒ£ OPERATIONAL PARAMETERS

  - âœ… Appointment Policies:
    - Maximum late arrival tolerance (min)
    - Free rescheduling allowance (count)
    - Penalty for late cancellation (%)
    - No-show limit before blocking (count)
    - Refund administrative fee (%)
    - Refund request deadline (hours post-appointment)
    - Credit validity after no-show (days)
    - Extra recording time tolerance (min after appointment)
  - âœ… Authorized Communication Channels:
    - WhatsApp, SMS, Email (checkboxes)
  - âœ… Post-Appointment Reminder Timing:
    - Hours after appointment to send follow-up/results/surveys
  - âœ… Sender Name/Signature:
    - Identity visible in AI or system messages
  - âœ… Message Template Base:
    - Editable text with dynamic variables: {name}, {hour}, {doctor}, etc.
  - âœ… Use Default VITAS Policies:
    - Button to apply VITAS base policies (locked fields)
    - Displays: "Using VITAS base configuration (current version v1.x)"
    - Disclaimer: "By using VITAS defaults, clinic temporarily accepts system-defined operational conditions. Customization requires uploading your own legal documents."
  - âœ… Change History:
    - Date, User, Field Changed, Old Value, New Value
    - WORM storage for audit (RENHICE + Directiva 373-MINSA/OGTI-2025)

  ---
  7ï¸âƒ£ CLINIC LOCATIONS (Phase 2 - Multi-Location)

  - ğŸ”· Create, edit, inactivate clinic locations
  - ğŸ”· Required fields: Name, Address (street/number), District/Province/Department, Phone (optional), Status (Active/Inactive)
  - ğŸ”· Mark as Primary: Exactly one location must be primary
  - ğŸ”· Delete: Only if no professionals, schedules, or clinical histories linked
  - ğŸ”· Locations referenced by PractitionerRole.location and Agenda

  ---
  8ï¸âƒ£ MARKETING & COMMUNICATION

  Campaigns

  - âœ… Campaign Fields:
    - Campaign title (short text)
    - Validity (start-end dates; appears red when expired)
    - Linked services (multi-select from clinic services)
    - Campaign information (large text field with terms, prices, dates, restrictions)
    - Disclaimer: "Describe terms and conditions, including prices, validity, restrictions, and any text you want the AI assistant to use when responding to patients."
  - âš ï¸ Pending: Payment handling for discounted services

  Social Media

  - âœ… Add social media links:
    - Predefined options: Facebook, Instagram, TikTok, LinkedIn
    - "Other" option to add custom network name
  - âœ… AI assistant references these links when suggesting patients visit social media

  AI Virtual Assistant

  - âœ… Photo: Upload assistant avatar (visible to patient on WhatsApp)
  - âœ… Name: Personalized assistant name
  - âœ… WhatsApp Phone Number: Business number for chatbot
  - âœ… Webchat Link: Copy/paste link for embedding
    - Buttons: Copy, Generate QR, Test Link
    - QR download formats: PNG, SVG, PDF
    - White-label + "Powered by Vitas" footer
    - Patient sees: consent banner, quick OTP/signed-link identification, can register/book/pay

  ---
  9ï¸âƒ£ HUMAN SUPPORT CONFIGURATION

  - âœ… Contact Name/Role: e.g., "Patient Support Area", "Clinical Support"
  - âœ… Human Support Hours: When human staff responds (e.g., Mon-Fri 8:00-18:00)
  - âœ… Support Email: Official address for complaints, inquiries, ARCO rights
  - âœ… Support Phone/WhatsApp: Direct human support line
  - âœ… Support Web URL/Form: Link to clinic's contact/complaints form

  AI Assistant Behavior:

  - âœ… Shows only configured channels (if field empty, channel not offered)
  - âœ… Triggers on keywords: "human", "help", "operator", "complaint", "don't understand"
  - âœ… Outside Hours: "Our human team will respond during: Mon-Fri 8:00-18:00"
  - âœ… All Handoffs Logged: AuditEvent with date/time, request type, channel, user, reason

  Legal Compliance:
  - âœ… Law 31814 (AI with human supervision)
  - âœ… Law 29733 (personal data & ARCO rights)
  - âœ… Law 29414 (patient right to information & complaints)
  - âœ… Law 30024 & Directiva 373-MINSA/OGTI-2025 (digital health traceability)

  ---
  ğŸ”Ÿ MESSAGING & REMINDERS

  Configuration Parameters:

  - âœ… Number of Reminders: Total messages sent before appointment (e.g., 2)
  - âœ… Send Intervals: When reminders are sent (e.g., 24h, 1h before appointment)
  - âœ… Allowed Send Hours: Time window to avoid nocturnal messages (e.g., 08:00-21:00)
  - âœ… Authorized Channels: WhatsApp, SMS, Email
  - âœ… Post-Appointment Reminder Time: Hours after appointment to send follow-up/results/surveys
  - âœ… Sender Name: Identity shown in messages (e.g., "Clinic VITAS Lima")
  - âœ… Base Message Template: Editable text with variables: {name}, {hour}, {doctor}, etc.

  AI Assistant Behavior:

  - âœ… Automatic Language Detection: Responds in patient's initial language
  - âœ… Consent-Based Sending:
    - Messages only sent if "External Messages" consent is âœ… Active
    - If âœ— Revoked or âŒ Not Accepted â†’ all sending blocked immediately
  - âœ… Respects Send Hours: No messages outside configured window
  - âœ… Auto-Cancellation: Pending messages canceled if appointment is canceled/rescheduled
  - âœ… Personalized Messaging (Intelligent Mode): AI adapts content by patient, appointment type, doctor, specialty, operational parameters

  Message Types:

  1. Pre-Appointment Reminders (based on intervals)
  2. Post-Appointment (results/satisfaction surveys)
  3. Administrative Alerts (pending payments, no-show penalties)
  4. Support Communications (human handoff messages)

  Message History & Audit:

  - âœ… Message Log (Admin View):
    - Date, Message Type, Channel, Status, Actor, Result
    - Filters: patient, date, channel, message type
    - Read-only table
  - âœ… Logged Fields:
    - Exact date/time, Channel (WhatsApp/SMS/Email), Message type, Responsible actor (AI/system/human), Status (sent/delivered/failed/canceled), Linked consent, Purpose (purposeOfUse: treatment/administration/follow-up), Delivery
  result
  - âœ… 12-Month Minimum Retention for audit
  - âœ… WORM Storage (Write-Once-Read-Many) to prevent tampering

  Compliance:
  - âœ… Law 29733 (express consent for electronic communications)
  - âœ… Law 31814 (transparency & human supervision of AI)
  - âœ… NTS 139-MINSA (timely communication with health user)

  ---
  1ï¸âƒ£1ï¸âƒ£ SERVICES OF HEALTH - SPECIALTIES & PROCEDURES

  Medical Specialties Management

  - âœ… Pre-Creation (from Services module):
    - + Add Specialty â†’ autocomplete search (suggest or "Create '{text}'")
    - Saved as ğŸ”µ Planned (blue): parameterizable, not yet schedulable
  - âœ… Just-in-Time Creation (Phase 2 - from Clinical Professionals):
    - While adding professional â†’ create & assign specialty simultaneously
  - âœ… Specialty States:
    - ğŸ”µ Planned (blue) â†’ Created, no doctors assigned, not schedulable
    - ğŸŸ¢ Active (green) â†’ â‰¥1 doctor assigned, schedulable
    - ğŸ”´ Inactive (red) â†’ Paused/closed, no new appointments, historical data intact
  - âœ… State Transitions:
    - Planned â†’ Active: automatic when first PractitionerRole (doctor) is created
    - Active â†’ Inactive: admin action (deactivate button)
    - Inactive â†’ Active: admin action (reactivate button)
    - No Active â†’ Planned transition
  - âœ… Configurable Parameters per Specialty:
    - Appointment duration (min): 10, 15, 20, 30, etc.
    - Buffer between appointments (min): 0-30 min (non-schedulable time after appointment for operations/cleanup/SOAP/transition)
    - Base consultation price: Standard rate for all doctors in specialty
  - âœ… Automatic Parameters (read-only, global policy):
    - Late = 30% of duration: Grace period before marking "Late"
    - No-show = 100% of duration: Threshold before marking "No-show"
  - âœ… Buffer Rules (Phase 1):
    - Configurable per specialty (and per location if applicable)
    - Suggested default: 10% of duration (min 1 min), range 0-30 min
    - Does not generate schedulable slots
    - If actual appointment end â‰¤ buffer â†’ next appointment doesn't move
    - If actual end exceeds buffer â†’ next appointment shifts by excess (marked "delay", no intrusive banners in F1)
    - Late/no-show evaluated against programmed time (not buffer)
    - Respects doctor's pauses/blocks
    - Not counted as productive time in reports
    - Changing duration recalculates grid; buffer unchanged unless manually edited
  - âœ… Assign Doctor (Phase 1):
    - From Clinical â†’ Professional Profile â†’ + Add Clinical Role
    - Admin selects existing specialty from catalog
    - Creates Doctor â†” Specialty â†” Location link (PractitionerRole)
    - Auto-activates specialty if it was Planned
    - Doctor must have active user account (Clinical system role)
  - âœ… "Search or Create" Flow (UI from Services):
    - Autocomplete: suggests while typing; if none, "Create '{text}'"
    - On select/create: saves and shows "Specialty saved âœ“"
    - Anti-duplication: normalize name (singular, standard capitalization); if close match â†’ "Use existing 'Dermatology'?"
    - No codes in UI (Phase 2/3: map to SNOMED/MINSA)
  - âœ… Responsibilities:
    - Admin defines/updates specialty parameters
    - Doctors only manage blocks/pauses in their agenda
    - Admin changes impact all doctors in specialty
  - âœ… Visibility:
    - Health Professionals module: shows only Active specialties
    - Services module: shows all (with state chips; optional filters later)
  - âœ… Card UI (list):
    - Tap â†’ Detail (no quick switches)
    - Content: Name Â· Price (Active=normal; Planned="Define/â€”"; Inactive=gray) Â· Location (if applicable) Â· State chip (green/blue/red)
  - âœ… Empty States:
    - Initial: "You don't have specialties yet. Search or create them with the field above."
    - No matches: "No specialties found for '{text}'. Create '{text}'"
  - âœ… Edit Parameters:
    - Tap specialty card â†’ Detail â†’ âœ Edit Parameters (modal)
    - Specialty name: read-only (don't change for traceability; if no longer offered, deactivate and create new if needed)
    - Editable fields (integers; location-scoped if applicable):
        - Appointment duration (min)
      - Buffer between appointments (min)
      - Base consultation price
    - Automatic fields (read-only):
        - Late = 30% of duration
      - No-show = 100% of duration
    - Validations: Duration: 5-min step, min 5 | Buffer: 0-30 min, integers, hint "does not generate slots" | Preview recalculated "Late"/"No-show" in minutes when duration changes
    - Confirmation: If doctors already linked â†’ alert: "âš  This change will impact all doctors in this specialty. Continue?" [Save Changes] [Cancel]
    - On save: parameters apply immediately to all doctors; future schedule recalculated per rules; historical data unchanged
  - âœ… Deactivate Specialty:
    - From detail â†’ Deactivate Specialty button (red outline)
    - Confirmation Modal:
        - "By deactivating this specialty:"
      - "â€¢ No new appointments can be created in this specialty"
      - "â€¢ Doctors will stop receiving bookings in this specialty"
      - "â€¢ Appointment and billing history will be preserved"
      - "Continue?" [Cancel] / [Deactivate]
    - Effect:
        - Changes state to ğŸ”´ Inactive
      - Historical clinical/financial data intact
      - Doctors no longer receive new bookings in this specialty
      - Future appointments: handled per clinic policy (attend / reschedule)
      - Registers AuditEvent with user, date/time, reason
    - Restrictions:
        - Cannot delete specialty with doctors or historical appointments; only deactivate
      - If never had doctors or appointments â†’ allow Delete Permanently (hard delete) with double confirmation
    - UI States:
        - Active / Inactive (chip visible on card)
      - (Filters optional in future versions)
    - Visibility in "Health Professionals":
        - Shows only Active specialties
      - On deactivate: specialty group disappears; doctor still visible in other active specialties; if only specialty â†’ doctor not listed (but user account remains active)
  - âœ… Reactivate Specialty:
    - List filtered by Inactive â†’ select specialty â†’ detail â†’ Reactivate button
    - Confirmation Modal:
        - "You are about to reactivate this specialty."
      - "â€¢ Doctors will be able to receive bookings in this specialty again"
      - "â€¢ Patients will be able to schedule new appointments"
      - "Continue?" [Reactivate] / [Cancel]
    - Effect:
        - Returns to ğŸŸ¢ Active, recovering all previous parameters (duration, buffer, price)
      - Doctors previously linked regain specialty in their profiles
      - Historical data intact; no duplication
      - Audit: registers user & date/time
  - âœ… AI Assistant (WhatsApp):
    - If patient tries to book Inactive specialty: "This specialty is no longer available at the clinic. Would you like to see other available options?"

  ---
  Procedures Management

  - âœ… Add Procedure (Global IPRESS Catalog):
    - Admin adds procedures/interventions to clinic's global catalog
    - Available for all doctors, no prior specialty association required
    - Access: Services â†’ Procedures â†’ + Add Procedure (modal)
  - âœ… Procedure Fields:
    - Procedure: search field with autocomplete (filters by name; doesn't show codes)
    - Standard duration (min): reference/administrative value (planning & costing); actual time may vary by clinical case
    - Base price (S/): required, admin-defined, used for patient transparency & uniform billing
    - Modality: Phase 1 = all In-Person only
    - Location/Site: selector for location where procedure is offered
    - IPRESS Internal Code (optional): short alphanumeric identifier, unique within IPRESS, used for ERP/insurance/accounting
    - Buttons: Cancel (left, gray) / Save (right, blue)
  - âœ… Behavior & Rules:
    - No mandatory specialty association at creation; procedure becomes globally available for IPRESS
    - In Doctor's Appointment Detail:
        - Search shows procedures relevant to doctor's specialty first (prioritization)
      - Allows searching entire global catalog if procedure not in suggested list
    - AI Scribe may suggest procedures; doctor can accept, edit, or delete them
    - Backend Codifications (not visible in UI):
        - VITAS.code (internal master ID, immutable)
      - ICHI (international standard)
      - Local catalog per country (e.g., IEDS in Peru)
      - IPRESS Internal Code (if entered)
    - Internal Code Validations:
        - Must be unique
      - Short alphanumeric format
      - Editable only while no billing/orders exist; afterward, requires controlled change flow
  - âœ… States & Messages:
    - If no active specialties in clinic and admin enters Procedures: Show notice: "To operate procedures in appointments, first activate at least one specialty." [Go to Specialties]
    - No search matches: "No procedures found for '{text}'. Try another term."
    - Catalog fails to load: "Could not load catalog. Retry later."
  - âœ… Edit Procedure:
    - List â†’ select procedure â†’ detail modal
    - From modal: Edit (modify parameters) or Deactivate/Delete per rules
  - âœ… Edit Rules:
    - Read-Only Fields:
        - Procedure name (derived from VITAS master catalog)
      - Automatic codifications: VITAS.code, ichi_code, ichi_display, ieds_code, ieds_display, SNOMED (future)
      - Usage history (count of appointments/orders where used)
    - Editable Fields:
        - Standard duration (min) â†’ reference/administrative (doesn't condition clinical practice)
      - Base price (S/) â†’ required
      - Modality â†’ Phase 1: In-Person only
      - Location/Site
      - IPRESS Internal Code â†’ editable only if not yet used in billing/orders; otherwise requires controlled change flow
    - Confirmation & Save:
        - Buttons: Cancel (left, gray) / Save Changes (right, blue)
      - If procedure already has appointments/billing: show warning: "âš  Attention: Changes in duration or price will impact all doctors and future appointments using this procedure. Continue?"
  - âœ… Deactivate vs. Delete:
    - Delete Permanently â†’ only allowed if procedure has never been used in appointments, orders, or billing
    - Deactivate â†’ if already used:
        - Becomes inactive and cannot be selected in new appointments
      - Clinical and administrative history preserved
      - Can be reactivated in the future if IPRESS requires it

  - âœ… Deactivate Procedure:
    - Detail modal â†’ Deactivate button
    - Confirmation:
        - "By deactivating this procedure:"
      - "â€¢ Cannot be selected in new appointments"
      - "â€¢ Internal billing for this procedure will be disabled"
      - "â€¢ Clinical and administrative history will be preserved"
      - "Continue?" [Cancel] / [Deactivate]
    - Effect:
        - Status â†’ ğŸ”´ Inactive
      - Cannot be used in new appointments/orders or billed internally
      - In doctor's UI: if manually searched or AI-suggested, shows notice: "This procedure is inactive at the clinic. If the case requires it, can be indicated for external performance."
      - If doctor selects it â†’ registered as Requested (outside IPRESS) (no internal execution/billing)
      - System registers audit: user, date/time, reason (optional)
    - Restrictions:
        - Cannot delete procedure with appointments/orders/billing history; only deactivate
      - If never used â†’ allow Delete Permanently (hard delete) with double confirmation
  - âœ… Reactivate Procedure:
    - List filtered by Inactive â†’ select procedure â†’ detail modal â†’ Reactivate button
    - Confirmation:
        - "You are about to reactivate this procedure."
      - "â€¢ Will be available again in new appointments"
      - "â€¢ Internal billing will be enabled"
      - "Continue?" [Reactivate] / [Cancel]
    - Effect:
        - Returns to ğŸŸ¢ Active, recovering previous parameters (duration, price, location, internal code)
      - Available again in Appointment Detail for doctors
      - Historical data intact; no duplication
      - Registers audit: user & date/time
  - âœ… Procedures Outside IPRESS:
    - IPRESS Procedure Catalog is fed from VITAS Master Catalog, which includes mappings to:
        - ICHI (international procedures)
      - Local Catalog per country (e.g., IEDS in Peru)
      - SNOMED CT (if applicable)
    - Admin selects procedures that will be active in the clinic and configures parameters (base price, standard duration, location, internal code)
    - Active procedures appear as available options in Appointment Detail and can be requested & billed within clinic
    - Clinical Exception:
        - Doctors can prescribe any procedure from VITAS Master Catalog, even if not active in IPRESS
      - In such cases:
            - Procedure marked in clinical history as Requested (outside IPRESS)
        - No execution/billing enabled within clinic
        - System informs patient: "This procedure is not available at this clinic. Can be performed at another center."
    - Principle:
        - Admin controls clinic's operational offering
      - Doctor retains clinical freedom to prescribe what's necessary, ensuring traceability even if IPRESS doesn't offer the procedure
      - Patient receives clear, transparent info on what can be done in-clinic vs. what must be referred elsewhere
  - âœ… VITAS Catalog Maintenance:
    - VITAS Catalog is a central inventory based on WHO ICHI standard
    - Maintenance is system responsibility, performed automatically without IPRESS admin intervention
    - Maintenance Rules:
        - When WHO updates ICHI â†’ system auto-updates ichi_code and ichi_display, maintaining immutable VITAS.code
      - When MINSA updates IEDS (Peru) â†’ system updates mappings (ieds_code, ieds_display) and registers new fecha_version of national catalog used
      - In future phases, if Vitas expands to other countries â†’ local catalog codes for those countries can be added to same VITAS.code, ensuring global traceability
      - Backend also stores reference to SNOMED CT as future integration for international interoperability (not included in Phase 1)
    - Principle:
        - IPRESS admin does not create or maintain procedures from scratch; always selects from VITAS Catalog
      - System ensures international and national codes remain updated and consistent at all times

  ---
  1ï¸âƒ£2ï¸âƒ£ HEALTH PROFESSIONALS MODULE

  Professional List

  - âœ… Visual Hierarchy:
    - H1: "Health Professionals"
    - Search bar: "Search professionals"
    - Section controls: + Add Professional (centered button)
    - H2: "Professional List"
    - Headings: Specialties (as section dividers, fixed on scroll)
    - Cards: Within each heading
  - âœ… Card Content (PractitionerRole = Professional + Specialty + Location):
    - Name & Surname (bold)
    - CMP (if doctor): Format "CMP 12345"
    - Location: "Location: San Vitas Surco"
    - Photo (optional; placeholder if none)
    - No "Active" chip (list shows only active by default)
    - Tap card: Opens â†’ Professional Profile
  - âœ… Search Behavior (Phase 1):
    - Search Fields: Practitioner.name (names & surnames) and Practitioner.qualification (CMP only)
    - NOT indexed in F1: DNI/CE/Passport, RNE, email, phone
    - Matching Rules:
        - Case & accent insensitive
      - Space tokenization with AND operator (all tokens must match in some field)
      - Partial prefix match from 2 chars ("an" matches "Ana", "AndrÃ©s")
      - Numeric search: If input is numeric (e.g., 1234), search in CMP; accept variants: CMP1234, CMP 1234, or just 1234
      - Normalization: collapse multiple spaces, ignore dots/commas in query
    - Scope: Searches only Active professionals (Inactive not shown in F1)
    - Result Order:
        i. Exact CMP matches first (if input numeric)
      ii. Then by Surname Aâ€“Z within each Heading (specialty)
      iii. Maintain grouping by specialty (Headings) in render
    - Performance & UX:
        - Debounce: 250 ms
      - Min chars: 2 to activate search
      - Limit results per render: 50 items (virtualization if list extensive)
      - Clear button (âœ•): appears when text present; clears field & restores default list
      - Empty: message "No professionals found with '{text}'"
  - âœ… General Behavior & Rules (Phase 1):
    - Grouping: always by Specialty (Headings)
    - Default Order: alphabetical by Surname
    - Visibility: list shows only Active; Inactive not listed in F1
    - Deactivate: not on card; done from Professional Profile
    - Reactivate: if onboarding detects match with Inactive professional, admin reactivates from Professional Profile (no duplicate creation)

  Add Professional (Phase 1)

  - âœ… + Add Professional button redirects to Account Settings â†’ Users & Permissions â†’ + Add User (Role: Clinical)
  - âœ… Phase 2:
    - From Account Settings â†’ Users & Permissions: can pre-fill data, send invitation, and link user with professional (no duplicate records)
    - (Optional: re-enable direct creation from Clinic with pre-fill)
  - âœ… Rule Maintained:
    - Professional is schedulable only when User is Active and has â‰¥1 Active Clinical Role (Specialty/Location)

  Professional Profile

  - âœ… Navigation: Clinic â†’ Health Professionals â†’ Professional Profile
  - âœ… Internal Sections:
    a. Personal Data
    b. Professional Data

  (Security access is external link; not a section here)
  - âœ… Personal Data Section:
    - Photo + Full Name
    - Document (DNI/CE/Passport): masked (e.g., --123)
    - Document Type/Number, Date of Birth (Age calculated), Gender, Address
    - Phone (personal contact) and Email (personal contact) â€” read-only; edited in Users & Permissions (OTP)
    - Emergency Contact Phone (read & edit by Admin)
    - Edit (Admin): official fields editable
    - Editing Mode per Section:
        - Each of two sections (Personal Data and Professional Data) has pencil button at bottom
      - Pressing pencil â†’ only that section enters edit mode; other stays read-only
      - In edit mode: Save and Cancel buttons appear within same section (at bottom)
      - Validation: only active section fields
      - Concurrency: edit one section at a time
      - Exit with unsaved changes: if attempting to switch section or leave, show confirmation to save/discard
  - âœ… Professional Data Section:
    - Concept: each role is a PractitionerRole = Professional + Specialty + Location
    - Initial Section Fields (no independent header):
        - CMP (if doctor) and RNE (if exists)
      - Quick Access Links:
            - View professional's schedule (navigates to schedule view)
        - Edit user access (navigates to Users & Permissions)
      - Status Notice: if all roles inactive, show banner: "This professional has no active roles. Cannot receive new appointments."
    - Professional Summary (derived from active roles):
        - Profession (catalog: Human Medicine, Obstetrics, Nursing, etc.)
      - Active specialties (summary): comma-separated list
      - Primary work location (read-only; marked as primary in one role)
      - Secondary work locations (read-only; rest of active locations)
      - Digital Signature (graphic): transparent PNG image of handwritten signature (optional; non-binding value). Phase 2: digital signature certificate for clinical documents
    - Role List (table/cards):
        - Specialty Â· Location Â· Status (Active / Inactive / Suspended by specialty) Â· Schedule (Configure) Â· Action (Deactivate)
      - Available Action (F1): Deactivate (role)
      - Reactivate not in this profile in F1 (see next)
      - Schedule Access: Configure Schedule button per role â†’ block/pause configuration (duration & rules come from Specialty)
    - Add Role:
        - + Add Role (specialty/location) button:
            - Specialty: select from catalog (Active only)
        - Location: select one or multiple
                - In F1 mono-location: Location (Site) auto-assigned to clinic's default location
        - Result: creates PractitionerRole.active=true per combination
        - Audit: professional.role.add
    - Schedule Sub-Block (within Professional Data):
        - View per role with direct access to Configure Schedule (blocks/pauses)
      - Global parameters (duration/buffers/no-show) come from Specialty and are not editable here in F1
  - âœ… Deactivate Role (F1):
    - Action: Deactivate button in role row/card
    - Confirmation: "You are about to deactivate this role (Specialty/Location). The professional will stop receiving new appointments in this combination. Continue?" [Deactivate] [Cancel]
    - Effect: PractitionerRole.active=false; role no longer appears in List (F1 shows only active); Historical data intact
  - âœ… Reactivate Role (F1):
    - Not available in this profile
    - Performed via deduplication in + Add Professional: when entering Document or CMP of inactive professional, system proposes Reactivate (no duplicate)
    - Phase 2: Reactivate button in this profile (per role) with same audit
  - âœ… States & Dependencies:
    - Suspended by specialty: if Specialty is inactive, role becomes suspended (no appointments) and Deactivate is disabled (already out of operation)
    - Account vs Role: activate/block account (login) is done in Settings â†’ Account Security and does NOT change PractitionerRole.active
  - âœ… Cross Links:
    - View account security â†’ Settings â†’ Security
    - View Specialty â†’ opens specialty detail (duration/buffers/base price)
  - âœ… Errors & Empty States:
    - No roles: show CTA + Add Role (specialty/location)
    - Inactive Specialty: prevent adding role with that specialty (clarifying message)
    - Save Error: banner with Retry and preserve local changes

  ---
  ğŸ”· PHASE 2 - PLANNED FEATURES

  Advanced Features (Not in Phase 1)

  - ğŸ”· Audit History Export: CSV export with filters (date, user, action) in Account Settings â†’ Security
  - ğŸ”· Just-in-Time Specialty Creation: Create specialty while adding professional
  - ğŸ”· Multi-Location Management: Assign professionals to multiple clinic locations
  - ğŸ”· Invite Doctors from Services Module: Direct from Specialty Detail
  - ğŸ”· Financial & Statistics Modules: Revenue tracking, performance metrics
  - ğŸ”· Advanced User Roles: Secretary, Location Admin, Auditor roles
  - ğŸ”· Automatic CMP Validation: Against Peruvian Medical Board (Colegio MÃ©dico del PerÃº) registry
  - ğŸ”· Professional Deduplication: Match by DNI/CMP to prevent duplicates
  - ğŸ”· Advanced Session Control: Force password reset
  - ğŸ”· Buffer by Attention Type (Specialty): Consultation vs Procedure, with fallback to base buffer
  - ğŸ”· Global IPRESS Parameters for Delay:
    - Delay notice threshold (â‰¥5 min, editable)
    - Reprogramming offer threshold (â‰¥15 min, editable)
    - Authorized send hours (e.g., 08:00-21:00)
    - Message templates (notice / offer reprogramming)
  - ğŸ”· Delay Notification Behavior:
    - ETA (estimated attention time) based on accumulated delay; respects pauses/blocks
    - Anti-spam: max 1 notice per appointment; second notice only if additional ETA change â‰¥5 min
    - Patient "arrived": no messaging; notifies Reception
    - Consents: messages only if Privacy âœ“ and External Messages âœ“
  - ğŸ”· AI Assistant Delay Flows:
    - Courtesy notice (â‰¥notice threshold): "Your {HH:mm} appointment has ~{X} min delay. ETA: {HH:mm}."
    - Reprogramming offer (â‰¥reprogramming threshold): "Delay may exceed {X} min. Wish to reschedule?" (1) Keep (2) Reschedule first option (3) See more options; rescheduling may require OTP; 90s hold on alternate slot
  - ğŸ”· Audit & Reports:
    - AuditEvent: delay.detected, delay.notify, delay.offer_rebook, appointment.rebooked/rebook_declined, frontdesk.alerted (with appointmentId, delayMinutes, oldStart/newETA, channel, actor, timestamp, outcome)
    - Reports: % buffer consumed, delay minutes, punctuality, avg wait time (CSV export)
    - Buffer excluded from productivity
  - ğŸ”· List Filters & Sorting (Professionals):
    - Filters: Status â†’ "Include inactive", Location, Specialty (with badge & active chips); located next to "Sort", between Section title and Search bar
    - Sort: Aâ€“Z / Recent (optional duplicate inside filter panel); located next to "Filters"
  - ğŸ”· Reactivate Role Button in Profile: With same audit as deduplication flow
  - ğŸ”· Required Reason for Deactivate/Activate Role
  - ğŸ”· Digital Signature Panel: Professional's signature certificate & validity status
  - ğŸ”· Contact Edit with Inline OTP

  ---
  âœ… TECHNICAL CHECKLIST

  Data Model (DynamoDB Tables)

  - âœ… users (userDetails, status: pending/incomplete/pending_validation/active/inactive, mfa_enabled)
  - âœ… tenants (clinic/IPRESS info, ownerUserId, status)
  - âœ… audit_logs (userId, tenantId, action, ip, timestamp, entity_type, entity_id, metadata)
  - âœ… legal_documents (type, target, version, hash, url, is_active)
  - âœ… Doctors_Table_V2 (doctor_id, email-index, active_for_ai_booking-index)
  - âœ… Patients_Table_V2 (patient_id, phone_number-index, chatbot_access)
  - âœ… PatientDoctors (junction: doctor_id PK, patient_id SK)
  - âœ… Appointments_Table_V2 (appointment_id-index, doctor_id-index, doctor_id-created_at-index)
  - âœ… Vitas_Appointment (appointment_id-index, TTL for unpaid)
  - âœ… Vitas_Schedule_Config (doctor_id PK, CONFIG SK, weekday slots)
  - âœ… vitas-otp (phoneNumber PK, context: chatbot/payment, 5-min TTL)
  - âœ… wa_sessions (WhatsApp session, threadId, jwt, 15-min idle TTL, 1-hour max)

  API Endpoints (Phase 1)

  - âœ… POST /auth/register â†’ Create owner User
  - âœ… POST /auth/verify-email â†’ Verify token
  - âœ… POST /legal/accept-terms â†’ Simple electronic signature with IP
  - âœ… POST /tenant â†’ Create Tenant
  - âœ… GET /tenant/{tenantId}/users â†’ List users
  - âœ… POST /tenant/{tenantId}/users/invite â†’ Create User (invited), send invite_token
  - âœ… POST /auth/accept-invite â†’ Doctor creates password (invited â†’ incomplete)
  - âœ… PATCH /tenant/{tenantId}/users/{userId}/status â†’ State transitions
  - âœ… GET /me/clinical-profile â†’ Read professional profile
  - âœ… POST /me/clinical-profile â†’ Complete/update profile (incomplete â†’ pending)
  - âœ… POST /tenant/{tenantId}/doctors/{userId}/validate â†’ Admin validates (pending â†’ active)
  - âœ… POST /me/mfa/setup, /verify, /disable â†’ MFA management
  - âœ… GET /me/sessions â†’ List active sessions
  - âœ… DELETE /me/sessions/{sessionId} â†’ Revoke session
  - âœ… POST /legal/accept â†’ Record consent acceptance with IP/timestamp

  Security & Compliance

  - âœ… Argon2id for password hashing
  - âœ… JWT tokens (HS256): 24h doctor, 24h patient payment, 2h chatbot
  - âœ… Invite tokens: Single-use JWT/UUID, 24h validity
  - âœ… AWS S3 + KMS encryption for files (signatures, CMP, consent documents)
  - âœ… Rate Limiting via Upstash Redis
  - âœ… WORM storage (S3 Object Lock - Compliance) for audit trails
  - âœ… Legal Compliance:
    - âœ… Law 29733 (Personal Data Protection)
    - âœ… Law 29414 (Patient Rights)
    - âœ… Law 27269 (Digital Signatures)
    - âœ… Law 30024 (RENHICE - National Electronic Health Records)
    - âœ… Law 31814 (AI with Human Supervision)
    - âœ… NTS 139-MINSA (Technical Health Standard)
    - âœ… Directiva 373-MINSA/OGTI-2025 (Digital Health Audit)
    - âœ… OWASP Best Practices

  ---
  This updated functionality list is comprehensive and aligned with both the technical summary you provided and the complete PDF documentation. The implementation focuses on Phase 1 MVP with clear markers for Phase 2 futur